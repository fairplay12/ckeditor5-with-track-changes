/*
 *             Copyright (c) 2016 - 2020, CKSource - Frederico Knabben. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import _0x36d1ed from'@ckeditor/ckeditor5-core/src/plugin';import gt from'./trackchangesediting';import St from'@ckeditor/ckeditor5-comments/src/comments/commentsrepository';import Tt from'./ui/suggestioncontroller';import xt from'./ui/view/suggestionthreadview';import lt from'@ckeditor/ckeditor5-collaboration-core/src/users';import Et from'@ckeditor/ckeditor5-comments/src/annotations/annotations';import Nt from'@ckeditor/ckeditor5-comments/src/annotations/editorannotations';import Ut from'@ckeditor/ckeditor5-ui/src/model';import Wt from'@ckeditor/ckeditor5-utils/src/collection';import Ot from'@ckeditor/ckeditor5-ui/src/dropdown/button/splitbuttonview';import{createDropdown as Gt,addListToDropdown as Mt}from'@ckeditor/ckeditor5-ui/src/dropdown/utils';import Vt from'@ckeditor/ckeditor5-comments/src/utils/getdatetimeformatter';import Pt from'@ckeditor/ckeditor5-comments/src/utils/getmarkerdomelement';import qt from'../theme/icons/track-changes.svg';import{debounce as zt}from'lodash-es';export default class dt extends _0x36d1ed{static get['requires'](){return[Et,Nt,gt,St,lt];}static get['pluginName'](){return'TrackChangesUI';}constructor(_0xe196c5){super(_0xe196c5),this['_suggestionToController']=new Map(),this['_viewToController']=new Map(),this['st']=new Map();this['editor']['config']['define']('trackChanges.SuggestionThreadView',xt);}['init'](){const _0x1eae03=this['editor'],_0x48f6f9=_0x1eae03['plugins']['get']('TrackChangesEditing'),_0x3212d3=_0x1eae03['plugins']['get']('Annotations'),_0x2f90e9=_0x1eae03['plugins']['get']('EditorAnnotations'),_0x5f0c64=_0x1eae03['plugins']['get']('CommentsRepository');_0x1eae03['ui']['componentFactory']['add']('trackChanges',_0x3c0650=>this['ot'](_0x3c0650)),_0x2f90e9['addSourceCollector'](()=>{const _0x481af2=[];for(const [_0xb95115,_0x561258]of Array['from'](this['_suggestionToController'])){const _0x22661b=_0xb95115['getAllAdjacentSuggestions'](),_0x837a6a=[];for(const _0x3941e7 of _0x22661b){const _0x49affa=_0x3941e7['getRanges']();for(let _0x259ac9=0x0;_0x259ac9<_0x49affa['length'];_0x259ac9++)0x0==_0x259ac9&&_0x837a6a['length']>0x0?_0x837a6a[0x0]['end']=_0x49affa[0x0]['end']['clone']():_0x837a6a['push'](_0x49affa[_0x259ac9]);}_0x481af2['push']([_0x561258['view'],_0x837a6a]);}return _0x481af2;}),this['listenTo'](_0x48f6f9,'suggestionLoaded',(_0x28ade6,_0x480423)=>{let _0x1fd8e3=!0x1;const _0xca953e=zt(_0x3b5f9b=>{_0x1fd8e3||_0x3b5f9b?_0x1fd8e3&&_0x3b5f9b&&(this['nt'](_0x480423),_0x2f90e9['refreshSelectedViews'](),_0x1fd8e3=!0x1):(this['rt'](_0x480423),_0x2f90e9['refreshSelectedViews'](),_0x1fd8e3=!0x0);},0xa);this['st']['set'](_0x480423,_0xca953e),this['listenTo'](_0x480423,'change:previous',(_0x326a32,_0x4ca745,_0x13d346,_0x52281a)=>{_0x480423['isInContent']&&(null==_0x13d346?(this['ct'](_0x52281a['head']),_0xca953e(!0x1)):(this['ct'](_0x13d346['head']),_0xca953e(!0x0)));}),null===_0x480423['previous']?_0xca953e(!0x1):this['ct'](_0x480423['head']);}),this['listenTo'](_0x48f6f9,'suggestionUnloaded',(_0x487054,_0x52eea5,_0x52070c)=>{this['stopListening'](_0x52eea5,'change:previous'),this['st']['get'](_0x52eea5)['cancel'](),this['st']['delete'](_0x52eea5);const _0x4767be=_0x52070c?_0x52070c['head']:_0x52eea5,_0x28974e=this['_suggestionToController']['get'](_0x4767be);null!==_0x52070c&&this['ct'](_0x4767be),null===_0x52070c&&_0x28974e&&this['nt'](_0x52eea5);}),this['listenTo'](_0x48f6f9,'suggestionChanged',(_0x3abdaa,_0x39234f)=>{this['ct'](_0x39234f);}),this['listenTo'](_0x3212d3,'change:activeView',(_0xa0d9b2,_0x396c2e,_0x9da686,_0x2ecef3)=>{if(_0x2ecef3&&this['_viewToController']['has'](_0x2ecef3)&&(_0x2ecef3['isActive']=!0x1),_0x9da686&&this['_viewToController']['has'](_0x9da686)){const _0x4bc8fd=this['_viewToController']['get'](_0x9da686)['model']['getAllAdjacentSuggestions']();_0x9da686['isActive']=!0x0,_0x48f6f9['activeMarkers']=_0x4bc8fd['reduce']((_0x80c2cd,_0x1aeaef)=>[..._0x80c2cd,..._0x1aeaef['getMarkerNames']()],[]);}else _0x48f6f9['activeMarkers']=[];}),this['listenTo'](_0x5f0c64,'addComment',(_0x548439,{threadId:_0x2833b3,isFromAdapter:_0x43040c})=>{if(_0x43040c||!_0x48f6f9['hasSuggestion'](_0x2833b3))return;const _0x5a9266=_0x48f6f9['getSuggestion'](_0x2833b3);this['_suggestionToController']['get'](_0x5a9266)['view']['focus']();},{'priority':'lowest'});}['ot'](_0x1d95f6){const _0x3a5a1f=Gt(_0x1d95f6,Ot),_0x5347af=this['editor']['commands']['get']('trackChanges'),{t:t}=this['editor'];_0x3a5a1f['buttonView']['set']({'tooltip':t('Track\x20changes'),'label':t('Track\x20changes'),'icon':qt}),_0x3a5a1f['buttonView']['bind']('isOn')['to'](_0x5347af,'value'),_0x3a5a1f['buttonView']['on']('execute',()=>_0x5347af['execute']());const _0x3158f4=new Wt(),_0x4a2195=[{'type':'switchbutton','model':{'withText':!0x0,'label':t('Track\x20changes'),'commandName':'trackChanges'}},{'type':'separator'},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20suggestions'),'commandName':'acceptAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20selected\x20suggestions'),'commandName':'acceptSelectedSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20suggestions'),'commandName':'discardAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20selected\x20suggestions'),'commandName':'discardSelectedSuggestions'}}];for(const _0x308a80 of _0x4a2195){const _0x18ad91={'type':_0x308a80['type']};if(_0x308a80['model']){const _0x17ec48=new Ut(_0x308a80['model']),_0x58a1a9=this['editor']['commands']['get'](_0x17ec48['commandName']);_0x17ec48['bind']('isOn','isEnabled')['to'](_0x58a1a9,'value','isEnabled'),_0x18ad91['model']=_0x17ec48;}_0x3158f4['add'](_0x18ad91);}Mt(_0x3a5a1f,_0x3158f4);const _0x4fd3cc=_0x4a2195['filter'](_0x535386=>null!=_0x535386['model'])['map'](_0x7ec410=>this['editor']['commands']['get'](_0x7ec410['model']['commandName']));return _0x3a5a1f['buttonView']['actionView']['unbind']('isEnabled'),_0x3a5a1f['buttonView']['arrowView']['unbind']('isEnabled'),_0x3a5a1f['buttonView']['actionView']['bind']('isEnabled')['to'](_0x5347af,'isEnabled'),_0x3a5a1f['buttonView']['arrowView']['bind']('isEnabled')['toMany'](_0x4fd3cc,'isEnabled',(..._0x1261d8)=>_0x1261d8['some'](_0x314347=>_0x314347)),_0x3a5a1f['on']('execute',_0x30330e=>this['editor']['execute'](_0x30330e['source']['commandName'])),_0x3a5a1f;}['rt'](_0x2530af){const _0x599db2=this['editor'],_0x5910ff=_0x599db2['config'],_0x522373=_0x599db2['plugins']['get']('Annotations'),_0x33b195=_0x2530af['getAllAdjacentSuggestions']()['filter'](_0x45a5ef=>_0x45a5ef['isInContent']),_0x37062e=_0x599db2['plugins']['get']('Users')['me'],_0x193939=_0x599db2['commands']['get']('acceptSuggestion'),_0x2f0df3=_0x599db2['commands']['get']('discardSuggestion'),_0x4fcf4f=new(0x0,(_0x5910ff['get']('trackChanges'))['SuggestionThreadView'])(_0x599db2['locale'],_0x2530af,_0x37062e,{'editorConfig':_0x5910ff['get']('comments.editorConfig'),'maxCommentsWhenCollapsed':_0x5910ff['get']('comments.maxCommentsWhenCollapsed'),'maxThreadTotalWeight':_0x5910ff['get']('comments.maxThreadTotalWeight'),'maxCommentCharsWhenCollapsed':_0x5910ff['get']('comments.maxCommentCharsWhenCollapsed'),'formatDateTime':Vt(_0x5910ff['get']('locale')),'CommentView':_0x5910ff['get']('comments')['CommentView']}),_0x5c3d06=new Tt(_0x2530af,_0x4fcf4f,_0x193939,_0x2f0df3);_0x4fcf4f['descriptionParts']=_0x599db2['plugins']['get']('TrackChangesEditing')['_descriptionFactory']['getDescriptions'](_0x33b195),this['_suggestionToController']['set'](_0x2530af,_0x5c3d06),this['_viewToController']['set'](_0x4fcf4f,_0x5c3d06);const _0x46d5a8=_0x33b195[0x0]['getFirstMarker'](),_0xb5a48=_0x522373['add'](_0x4fcf4f,()=>Pt(_0x599db2['editing'],_0x46d5a8));_0xb5a48['bind']('type')['to'](_0x5c3d06['view'],'type',_0x2835bf=>'suggestion-'+_0x2835bf),_0xb5a48['bind']('hasChanges')['to'](_0x4fcf4f,'isDirty'),_0xb5a48['bind']('length')['to'](_0x4fcf4f);const _0x25872c=_0x599db2['plugins']['get']('PendingActions');let _0x1c8b5d;_0x4fcf4f['on']('change:isDirty',(_0x55f359,_0x5dc57d,_0x4977fa)=>{if(_0x4977fa){const t=this['editor']['locale']['t'];_0x1c8b5d=_0x25872c['add'](t({'string':'Unsaved\x20change\x20in\x20suggestion.','id':'PENDING_ACTION_SUGGESTION'}));}else _0x25872c['remove'](_0x1c8b5d),_0x1c8b5d=null;});}['nt'](_0x432b7b){const _0x3521ec=this['editor']['plugins']['get']('Annotations'),_0x21c979=this['_suggestionToController']['get'](_0x432b7b),_0x55cf78=_0x21c979['view'];_0x3521ec['remove'](_0x55cf78),this['_suggestionToController']['delete'](_0x432b7b),this['_viewToController']['delete'](_0x55cf78),_0x21c979['destroy'](),_0x55cf78['destroy']();}['ct'](_0x3768b4){if(!this['_suggestionToController']['has'](_0x3768b4))return;const _0x51941a=this['editor']['plugins']['get']('TrackChangesEditing'),_0x40ea6f=this['_suggestionToController']['get'](_0x3768b4),_0x32b176=_0x3768b4['getAllAdjacentSuggestions']();_0x40ea6f['view']['descriptionParts']=_0x51941a['_descriptionFactory']['getDescriptions'](_0x32b176);}['destroy'](){super['destroy']();for(const _0x1e538a of this['_suggestionToController']['keys']())this['nt'](_0x1e538a);for(const _0x55c79c of this['st']['values']())_0x55c79c['cancel']();this['st']['clear']();}}